<html>

<head>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script src="../libraries/js/jquery-3.2.1.min.js"></script>
    <script src="../libraries/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../libraries/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/loadingAnimation.css" />
    <script src="js/SelfEvaluationManager.js"></script>

    <style>
        header,
        footer {
            padding: 1em;
            color: white;
            background-color: #1d1d1d !important;
            clear: left;
            text-align: center;
        }


        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Roboto", "Ubuntu", "Helvetica Neue", sans-serif;
            line-height: 1.5;
            font-style: normal;
            font-weight: 400;

        }

        button {
            padding: 1em;
        }

        .category,
        .freeText {
            margin: 10px;
            border: 1px solid #ddd;
            border: 1px solid rgba(86, 61, 124, .2);
            padding: 1em;
        }

        .category:focus-within,
        .category:hover,
        .freeText:focus-within,
        .freeText:hover {
            box-shadow: 0 0 20px rgba(33, 33, 33, .2);
        }

        .category-footer {
            padding-top: 1em;
            margin-top: 10px;
            border-top: 0.5px dimgray dotted;
        }

        @media screen and (min-width: 990px) {
            select {
                float: right;
                clear: both;
            }
        }


        .loadingAnimation {
            height: 75%;
            display: flex;
            align-items: center;
            justify-content: center
        }
    </style>

    <script>

        $(document).ready(function () {
            $("#activityLoadingAnimation").show();
            getActivityCategories(getActivityId(), function (result, status) {

                var list = JSON.parse(result);

                $('#activityTitle').append(list.DATA[0].Title);
                $('#activitiDesc').append(list.DATA[0].Description);

                for (i = 0; i < list.DATA.length; i++) {
                    var riga = list.DATA[i];

                    var html = "<div id=\"category_" + riga.CategoryId + "\" class=\"category row-fluid container-fluid form-horizontal\">";
                    html += "<div class=\"row-fluid  container-fluid category-header\">    <div class=\"categoryTitle col-xs-12\">";
                    html += "<h4>" + riga.CategoryName + "</h4>    </div> </div> <div class=\"row-fluid  container-fluid category-body\">";

                    //category criteria
                    html += "<div id=\"category_" + riga.CategoryId + "-criterias\" class=\"col-sm-6 col-md-5\" style=\"padding-left: 0px; padding-right:opx;\"> </div>";

                    //students remarks
                    html += "<div class=\"col-sm-4 col-md-5 form-group\" > <label for=\"category_" + riga.CategoryId + "_remark\">Students remarks:</label>  <textarea name=\"remark\" id=\"category_" + riga.CategoryId + "_remark\" rows=\"5\" class=\"form-control\" placeholder=\"Students remarks\"></textarea>    </div>";

                    //self-evaluation
                    html += "<div class=\"col-sm-2 form-group\">  <label for=\"category_" + riga.CategoryId + "_selfEvaluation\">Self-evaluation:</label> <select name=\"selfEvaluation\" class=\"form-control\" id=\"category_" + riga.CategoryId + "_selfEvaluation\" placeholder=\"self-evaluation\"><option value=\"\"></option> <option>1</option> <option>2</option> <option>3</option> <option>4</option> <option>5</option> </select> </div> </div>";

                    //teacher evaluation
                    html += "<div class=\"row-fluid container-fluid category-footer\">    <div class=\"col-md-2 container-fluid\">        <span><strong>Teacher's evaluation: </strong></span>        <span>";
                    html += "<label id=\"category_" + riga.CategoryId + "-teacherEvaluation\" class=\"form-control\" style=\"text-align:center;\" disabled> </label>        </span>    </div>";

                    //teacher remark
                    html += "<div class=\"col-md-10\" style=\"text-align: justify; text-justify: inter-word;\">        <p id=\"category_" + riga.CategoryId + "-teacherNote\">            <strong> Teacher's note: </strong></p>    </div></div></div>";

                    $('#categoryContainer').append(html);

                    getCategoryCriterias(riga.CategoryId, addCriterias);
                }

                getSelfEvaluation(getActivityId(), setSelfEvaluation);

            });

        });

        function setSelfEvaluation(result, status) {

            if (result) {
                var list = JSON.parse(result);

                if (list.DATA.length > 0) {
                    $('#whatWeKnow').val(list.DATA[0].WhatWeKnow);
                    $('#notClear').val(list.DATA[0].NotClear);
                }
            }
        }

        function addCriterias(result, status) {

            var list = JSON.parse(result);

            var gruppedCriterias = groupCriteriaValues(list.DATA);

            var html = "";


            $.each(gruppedCriterias, function (index, criteria) {
                html += "<div class=\"row-fluid container-fluid form-group\" style=\"width: 100%; padding-bottom: 5px; padding-right: 0px; padding-left: 0px; margin:0px; \">";
                //html += "<div class=\"col-md-8\">" + criteria.Name + "</div>  <div class=\"col-md-4\">  <select id=\"category_" + criteria.Category + "-criteria_" + criteria.CritId + "-value\" class=\"form-control\"> <option value=\"\">-</option>";
                html += "<label for=\"category_" + criteria.Category + "-criteria_" + criteria.CritId + "_value\">" + criteria.Name + "</label>  <select id=\"category_" + criteria.Category + "-criteria_" + criteria.CritId + "_value\" name=\"criteria\" class=\"form-control\"> <option value=\"\">-</option>";

                for (i = 0; i < criteria.CritValues.length; i++) {
                    html += "<option value=\"" + criteria.CritValues[i] + "\">" + criteria.CritValues[i] + "</option>";
                }

                //html += "</select></div> </div>";
                html += "</select> </div>";
            });

            $('#category_' + list.DATA[0].Category + '-criterias').append(html);
            //alert("added criterias");
            getCategorySelfEvaluation(getActivityId(), list.DATA[0].Category, setCategorySelfEvaluation);
        }

        function setCategorySelfEvaluation(result, status) {

            if (result) {
                var list = JSON.parse(result);

                if (list.DATA.length > 0) {
                    //alert("setting eval criterias");
                    var gruppedEvaluations = groupEvaluations(list.DATA);

                    //$('#whatWeKnow').val(gruppedEvaluations.WhatWeKnow);
                    //$('#notClear').val(gruppedEvaluations.NotClear);

                    $('#category_' + gruppedEvaluations.Category + '_remark').val(gruppedEvaluations.Remark);
                    $('#category_' + gruppedEvaluations.Category + '_selfEvaluation').val(gruppedEvaluations.SelfEvaluation);
                    $('#category_' + gruppedEvaluations.Category + '-teacherEvaluation').append(gruppedEvaluations.TeacherEvaluation);
                    $('#category_' + gruppedEvaluations.Category + '-teacherNote').append(gruppedEvaluations.TeacherNote);

                    $.each(gruppedEvaluations.Criterias, function (index, critEval) {

                        $('#category_' + gruppedEvaluations.Category + '-criteria_' + critEval.Criteria + '_value').val(critEval.Value);

                        var selId = $('#category_' + gruppedEvaluations.Category + '-criteria_' + critEval.Criteria + '_value > option:selected').prevAll().length;
                        var a = selId;

                    });
                }
            }

            $("#activityLoadingAnimation").hide();
            $("#activityContainer").show();
            
        }

        function groupCriteriaValues(list) {

            var grouppedCritValues = Object.values(list.reduce((result, {
                CritId,
                Name,
                Value,
                Category
            }) => {
                // Create new group
                if (!result[CritId]) result[CritId] = {
                    CritId,
                    Name,
                    Category,
                    CritValues: [],
                };
                // Append to group
                result[CritId].CritValues.push(
                    Value
                );
                return result;
            }, {}));

            return grouppedCritValues;
        }

        function groupEvaluations(list) {

            if (list) {
                var grouppedEvaluaion = {
                    Category: list[0].Category,
                    SelfEvaluation: list[0].SelfEvaluation,
                    Remark: list[0].Remark,
                    TeacherEvaluation: list[0].TeacherEvaluation,
                    TeacherNote: list[0].TeacherNote,
                    TeacherSubmissionDate: list[0].TeacherSubmissionDate,
                    Criterias: []
                };

                $.each(list, function (index, row) {

                    grouppedEvaluaion.Criterias.push(
                        {
                            Criteria: row.Criteria,
                            Value: row.Value
                        });
                });

                return grouppedEvaluaion;
            }
        }

        function getActivityId() {
            var parameters = location.search.substring(1).split("&");

            var temp = parameters[0].split("=");
            id = unescape(temp[1]);

            return id;
        }

        function save() {
            var selfEvaluation = {
                Activity: getActivityId(),
                WhatWeKnow: $('#whatWeKnow').val(),
                NotClear: $('#notClear').val(),
                SubmissionDate: new Date(),
                Categories: []
            };


            $.each($('.category'), function (i, category) {

                var category = category.id;
                category = category.split("_")[1];
                var remark = $('#category_' + category + '_remark').val();
                var categoryEvaluation = $('#category_' + category + '_selfEvaluation').val();

                selfEvaluation.Categories.push({
                    Category: category,
                    Remark: remark,
                    SelfEvaluation: categoryEvaluation,
                    Criterias: []
                });

                $.each($('#category_' + category + '-criterias > .form-group > select'), function (index, criteria) {
                    var criteriaId = criteria.id;
                    criteriaId = criteriaId.split("_")[2];

                    selfEvaluation.Categories[i].Criterias.push({
                        Criteria: criteriaId,
                        Value: criteria.value
                    });

                });

            });
            saveSelfEvaluation(selfEvaluation, succesfullSave);
        }

        function succesfullSave(result, status) {
            //alert("success!! " + result);

            console.log(result);
        }

    </script>

</head>


<header>

    <h1 id="activityTitle"></h1>

    <p id="activitiDesc"></p>

</header>


<body>
    <div id="activityLoadingAnimation" class="loadingAnimation">
        <div class="sk-fading-circle">
            <div class="sk-circle1 sk-circle"></div>
            <div class="sk-circle2 sk-circle"></div>
            <div class="sk-circle3 sk-circle"></div>
            <div class="sk-circle4 sk-circle"></div>
            <div class="sk-circle5 sk-circle"></div>
            <div class="sk-circle6 sk-circle"></div>
            <div class="sk-circle7 sk-circle"></div>
            <div class="sk-circle8 sk-circle"></div>
            <div class="sk-circle9 sk-circle"></div>
            <div class="sk-circle10 sk-circle"></div>
            <div class="sk-circle11 sk-circle"></div>
            <div class="sk-circle12 sk-circle"></div>
        </div>
    </div>
    <div id="activityContainer" class="container-fluid" style="display:none;">


        <div id="categoryContainer" class="row-fluid ">

        </div>

        <div class="row-fluid">
            <div style="padding-bottom: 10px;">
                <div class="form-group container-fluid freeText">
                    <label for="whatWeKnow">What we know:</label>
                    <textarea id="whatWeKnow" rows="8" class="form-control" style="width: 100%;" placeholder="What we know"></textarea>
                </div>
                <div class="form-group container-fluid freeText">
                    <label for="notClear">What is not clear:</label>
                    <textarea id="notClear" rows="8" class="form-control" style="width: 100%;" placeholder="What is not clear"></textarea>
                </div>
            </div>
        </div>

        <div class="row-fluid ">
            <div class="row-fluid " style="text-align: center; ">
                <button type="submit" class="btn btn-primary btn-lg m-5" style="margin: 10px;" onclick="save()">Submit</button>
                <button type="button" name="goBack" class="btn btn-danger btn-lg m-5" style="margin: 10px;" data-toggle="modal" data-target="#myModal">Cancel</button>

            </div>
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>

                </div>
                <div class="modal-body">
                    Are you sure?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="goBack()">Go back!</button>
                </div>

                <script>
                    function goBack() {
                        window.history.back();
                    }
                </script>
            </div>
        </div>
    </div>

</body>


<footer>

</footer>

</html>