<!DOCTYPE html>
<html lang="en">
<head>
	
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
	<title>Welcome to eCraft2Learn</title>
	
	<script src="libraries/js/jquery-3.3.1.min.js"></script>
	
	<link rel="stylesheet" href="libraries/css/bootstrap.min.css">
<!-- 	https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7 -->
    <script src="libraries/js/bootstrap.min.js"></script>  


    <!--<link href="libraries/css/metro.css" rel="stylesheet">
	<link href="libraries/css/metro-schemes.css" rel="stylesheet">
	<link href="libraries/css/metro-icons.css" rel="stylesheet">-->
	<link rel="stylesheet" href="libraries/css/metro-all.min.css">
    <script src="libraries/js/metro.js"></script>

<!-- Sentry will report bugs to us -->
<!--     <script src="https://cdn.ravenjs.com/3.22.1/raven.min.js" crossorigin="anonymous"></script> -->
    <script>
    if (navigator.onLine) {
    	// if offline no need to even try to load sentry
    	let script = document.createElement('script');
    	script.src = "https://cdn.ravenjs.com/3.22.1/raven.min.js";
    	script.crossorigin = "anonymous";
    	document.head.appendChild(script);
    	script.addEventListener('load',
    	                        function () {
									Raven.config('https://7780e314f7d64cc88db0fab885c9ca9b@sentry.io/305194',
											     {whitelistUrls: [/ecraft2learn\.github\.io/]})
										 .install();	                        	
    	                        });
    }  
    </script>

    <link rel="icon" type="image/png" href="images/eCraft2Learn-Favicon.png" />
	
		
	<!-- This links to the css file that we use for coloring of the tiles. The themes are stored in the "themes" folder. Change this to see other themes-->
	<link rel="stylesheet" type="text/css" href="themes/theme-3.css" />
	<link rel="stylesheet" type="text/css" href="extra-btn.css" />
	
	<script src="js/window-management.js"></script>
	<script src="js/helper-functions.js"></script>

	<script src="js/file_manager.js"></script>
	


	<!--LNU CODE START-->
	<script src="lnu/commenting/js/feedback-window-managment.js"></script>
	<!--LNU CODE END-->

	<style>
        .tile-area-controls {
            position: fixed;
            right: 40px;
            top: 40px;
        }

        .tile-group {
            margin-left: 0;
			margin-top: 50px;
        }

        .tile, .tile-small, .tile-sqaure, .tile-wide, .tile-large, .tile-big, .tile-super {
            opacity: 0;
            -webkit-transform: scale(.8);
            transform: scale(.8);
        }

        #charmSettings .button {
            margin: 5px;
        }
		
		@media all and (min-width: 640px) {
		  .tiles-group {
			margin-left: 40px;
		  }
		  .tile-area {
                overflow-x: scroll;
            }
		}

        @media screen and (max-width: 640px) {
            .tile-area {
                overflow-y: scroll;
            }
            .tile-area-controls {
                display: none;
            }
			.tiles-group {
				margin-bottom: 40px;
			  }
        }

        @media screen and (max-width: 320px) {
            .tile-area {
                overflow-y: scroll;
            }

            .tile-area-controls {
                display: none;
            }
        }
		
		.login-form {
			width: 30rem;
			height: 20rem;
			background-color: #404436;

			position: absolute;
			top:0;
			bottom: 0;
			left: 0;
			right: 0;
			opacity: 0;

			margin: auto;
		}
    </style>
	
	<script>
	params={};location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(s,k,v){params[k]=v})
	
	$(function(){
            //$.StartScreen();

            var tiles = $(".tile, .tile-small, .tile-sqaure, .tile-wide, .tile-large, .tile-big, .tile-super");

            $.each(tiles, function(){
                var tile = $(this);
                setTimeout(function(){
                    tile.css({
                        opacity: 1,
                        "-webkit-transform": "scale(1)",
                        "transform": "scale(1)",
                        "-webkit-transition": ".3s",
                        "transition": ".3s"
                    });
                }, Math.floor(Math.random()*500));
            });

            $(".tile-group").animate({
                left: 0
            });
        });
		
	$(function(){
		//if(params['username']!="" && params['pilotsite']!="" && params['username']!=undefined && params['pilotsite']!=undefined){
		if ( window.sessionStorage.getItem("username")!=undefined 
		  		&& window.sessionStorage.getItem("pilotsite")!=undefined
		  		&& window.sessionStorage.getItem("userId")!=undefined
		  		&& window.sessionStorage.getItem("userId")!=-1)
		{
			$("#loginForm").hide();
			if (!navigator.onLine) {
				return;
			}
			(() => {

        			var sessionId = window.sessionStorage.getItem("pilotsite");// params['pilotsite'];

        			if (! sessionId)
                			return;

        			$.ajax({

                			type: 'POST',
                			data: 'sessionId=' + sessionId,
                			url: 'https://cs.uef.fi/~tapanit/ecraft2learn/api/pilot_2/get_materials.php',
                			success: (data) => {
									//alert(data);
                        			var urls = JSON.parse(data);

                        			var str = '';
									//<a href="#" data-role="searchable" onclick="showInOERWindow(event, './help/oer/3d_printing_troubleshooting_guide/3d_printing_troubleshooting_guide.pdf')">Other 3D Printing Problems</a>
                        			for (let i = 0; i < urls.length; i++) {

                                			//str += '<li><a target=\'_blank\' href=\'' + urls[i].url + '\'>' + urls[i].name + '</a></li>';
											str += '<li><a href="#" data-role="searchable" onclick="showInOERWindow(event, \'' + urls[i].url + '\')">' + urls[i].name + '</a></li>';
                        			}

						if (str !== '')
                        				$('#teacher-material').html(str);

                			},
                			error: (error) => {

                			}
        			});

			})();


			//alert(hashFnv32a(params['username']));
		}
		else{
			$("#userProgressDiv").hide();
			$("#loginForm").animate({opacity:1},1000);
		}
	});
	</script>
	
	<script>
		function infoClick(file) {
			if (file) {
			  /*make an HTTP request using the attribute value as the file name:*/
			  xhttp = new XMLHttpRequest();
			  xhttp.open("GET", file, true);
			  xhttp.send();
			  xhttp.onreadystatechange = function() {
				if (this.readyState == 4) {
				  if (this.status == 200) { 
					  Metro.infobox.create(this.responseText, "", {
						width: 600,
						removeOnClose: true
					  });
				  }
				  if (this.status == 404) { Metro.infobox.create("Page not found.");}
				}
			  }
			}
		}
		
		function helpClick(helpDialogId, event){
		
			//window.sessionStorage.setItem('username', params['username']);
            //window.sessionStorage.setItem('pilotsite', params['pilotsite']);
			var username = window.sessionStorage.getItem("username");
			var analyticField = getAnalyticFieldName(helpDialogId, true);
			openHelpDialog(helpDialogId, event);
			//sendAnalyticsData(hashFnv32a($("username")), 0, analyticField);
			sendAnalyticsData(hashFnv32a(username), 0, analyticField);
		}
		
		function tileClick(toolUrl, winTitle, event){
			var analyticField;
			
			if(winTitle==undefined) {
				analyticField = getAnalyticFieldName(toolUrl);
				gotoTileDestination(toolUrl);

			}
			else{
				analyticField = getAnalyticFieldName(toolUrl);
				
				//var url = toolUrl + '&username=' + params['username'] + '&sessionId=' + params['pilotsite'];
				//console.log(url);
				
				//window.sessionStorage.setItem('username', params['username']);
				//window.sessionStorage.setItem('pilotsite', params['pilotsite']);
				
				openIframeWindow(toolUrl, winTitle, event);

			}

			var username = window.sessionStorage.getItem("username");
			sendAnalyticsData(hashFnv32a(username), 0, analyticField);
			//sendAnalyticsData(hashFnv32a($("username")), 0, analyticField);

            //openFeedbackWindow("./lnu/commenting/index.html",winTitle,event);


		}
		function showInOERWindow(event, addr){
			//allWin = $("div").find('[class], bg-red');
			allWin = $("*").find("div[data-role*='dialog']");
			oerWin = $("#oerWin");	
			
			var oerMainFolder = "help/oer/";
			var eventNode = $(event.srcElement);
			var oerText = $(eventNode).html();
			var oerAddress = addr==undefined ? (oerMainFolder + oerText + "/" + oerText + ".html").toLowerCase().replace(/ /g,'_') : addr.toLowerCase();

			if ($(oerWin).html() == undefined)
			{
				var dialog = openIframeWindow(oerAddress, "Open Educational Resources", event);
				$(dialog).attr('id', 'oerWin');
				/*var iframe = $(dialog).find("[id|='iframeWindow']")[0];
				var dcmnt = (iframe.contentDocument || iframe.contentWindow.document);
				var otherhead = dcmnt.getElementsByTagName("head")[0];
				var link = dcmnt.createElement("link");
				link.setAttribute("rel", "stylesheet");
				link.setAttribute("type", "text/css");
				link.setAttribute("href", "../../libraries/css/metro.css");
				otherhead.appendChild(link);
				
				alert(otherhead.innerHTML);
				curHead = document.getElementByTagName("head");
				//iframe = $(dialog).getElementById("iframeWindow");
				iframe.reload();
				alert(curHead);
				if($(iframe).find("head").length == 0)
					$(iframe).append("<head></head>");
				alert($(iframe).find("td").length);*/
			}
			else{
				var iframe = $(oerWin).find("[id|='iframeWindow']")[0];
				$(iframe).attr('src', oerAddress);
				
				var oerMinimizedBtn = $("#oerWin_btn");
				if($(oerMinimizedBtn).attr('id') == 'oerWin_btn'){
					unminimizeWindowFromJS(oerMinimizedBtn);
				}
			}
		}
	</script>
	
</head>

<body class="bg-dark fg-white">

	<!-- Google Translate -->

	<!-- Conditionally activated if translate is in the hash term of the URL -- after the # -->
	<script>
	function googleTranslateElementInit() {
		 new google.translate.TranslateElement({pageLanguage: 'en',
												layout: google.translate.TranslateElement.InlineLayout.SIMPLE},
											   'google_translate_element');
	}
	if (window.location.hash.indexOf('translate') >= 0 && navigator.onLine) {
		var div = document.createElement('div');
		var add_div_and_script = function () {
			document.body.appendChild(div);
			var script = document.createElement('script');
			script.type = "text/javascript";
			script.src = "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
			document.body.appendChild(script);
		}
		div.id = "google_translate_element";
		if (document.body) {
			add_div_and_script();
		} else {
			// wait for the document to load
			document.addEventListener('DOMContentLoaded', add_div_and_script);
		}
	}
	</script>
	<script>
		function includeHTML() {
		  var z, i, elmnt, file, xhttp;
		  /*loop through a collection of all HTML elements:*/
		  z = document.getElementsByTagName("*");
		  for (i = 0; i < z.length; i++) {
			elmnt = z[i];
			/*search for elements with a certain atrribute:*/
			file = elmnt.getAttribute("include-html");
			if (file) {
			  /*make an HTTP request using the attribute value as the file name:*/
			  xhttp = new XMLHttpRequest();
			  xhttp.onreadystatechange = function() {
				if (this.readyState == 4) {
				  if (this.status == 200) {elmnt.innerHTML = this.responseText;}
				  if (this.status == 404) {elmnt.innerHTML = "Page not found.";}
				  /*remove the attribute, and call this function once more:*/
				  elmnt.removeAttribute("include-html");
				  includeHTML();
				}
			  }      
			  xhttp.open("GET", file, true);
			  xhttp.send();
			  /*exit the function:*/
			  return;
			}
		  }
		};
	</script>
	
	<div class="container-fluid start-screen no-overflow">
		<div class="grid">
			<div class="row">
				<div class="cell-9"> 
					<div class="pt-4 pl-4 pr-4 mb-0">
							<img id="eCraftLogo" src="images/eCraft2Learn-icon.png" />
					</div>
					<div id="eCraftMotto" class="mt-0">
						Digital Fabrication and Maker Movement in Education <!--(<a href="./help/troubleshooting/" target="_blank">Trouble shooting help</a>)-->
					</div>
				</div>
				<div class="cell-3">
					<!-- User name and progress -->
					<div id="userProgressDiv" class="m-4" style="position: absolute; right:0; top:10px;">
						<span class="icon mif-user"/>
						<a id="userBadge" href="#" onclick="openUserMenu();" class="sub-header no-margin text-light"><script>document.write(window.sessionStorage.getItem('username'));</script></span></a><br/>
						<div class="progress pull-right" data-role="progress" data-small="true" data-value="getUserProgress();" style="width:100%;"></div>
						<script>
							function openUserMenu(){
								$("#userMenu").show();
							}
							function getUserProgress(){
								var sessionId = window.sessionStorage.getItem('pilotsite');
								var users = window.sessionStorage.getItem('username');

								var formData = new FormData();
								formData.append("users", users);
								formData.append("sessionId", sessionId);

								$.ajax({
									url: 'http://cs.uef.fi/~tapanit/ecraft2learn/api/pilot_2/get_student_models_pilot_2.php',
									//url: 'http://localhost/fileman/fileman.php',
									dataType: 'text',
									cache: false,
									contentType: false,
									processData: false,
									data: formData,
									type: 'post',
									async: false,
									success: function (php_script_response) {
										//alert(php_script_response);
										return 50;
									}
								});
							}
						</script>
					</div>
					<div id="userMenu" class="m-2 p-4 bg-darkGray" style="position:absolute; right:0; top:0; display:none; z-index:1;">
						
						<div style="display:flex; justify-content: left; align-items: center; font-size:20px;"> <span class="icon mif-user mif-2x fg-lightTeal"></span> <span class="no-margin text-heavy"></span>&nbsp;<script>document.write(window.sessionStorage.getItem('username'));</script></span></div><br/>
						<div class="progress pull-right no-margin" data-role="progress" data-value="getUserProgress();" dataz-value="73" style="width:200px;"></div><br/><br/>
						<button type="button" class="button primary" onclick="logUserOut();">Logout</button>
						<button type="button" class="button primary" onclick="$('#userMenu').hide();">Cancel</button>
						<script>
							function logUserOut(){
								window.sessionStorage.clear();
								location.reload();
							}
						</script>
					</div>
				</div>
		<div class="tiles-area pt-20 pl-10 pr-10">
			<div class="tiles-grid tiles-group size-1 fg-white" data-group-title="Imagine">
				<div data-role="tile" class="bg-ideation fg-white" data-effect="hover-slide-up">
				<!--helpClick('#eCraftSearchDialog', event);-->
					<span class="mif-question badge-top m-0 bg-transparent" onclick="infoClick('./about/ecraft-search-help.html', '#eCraftSearchDialog');"></span>
					<div class="slide-front">
						<img class="icon" src="./images/google-drive-logo-flat.png"/>
						<span class="branding-bar">eCraft Search</span>
					</div>
					<div  class="slide-back text-small d-flex flex-justify-center flex-align-center p-3" onclick="tileClick('./uef/search/index.html', 'eCraft Search', event);">
						Use this to search for help from Maker web sites
					</div>
                </div>
				<div data-role="tile" class="bg-ideation fg-white" data-effect="hover-slide-up">
				<!--helpClick('#eCraftSearchDialog', event);-->
					<span class="mif-question badge-top m-0 bg-transparent" onclick="infoClick('./about/inspiratorium-help.html', '#inspiratoriumDialog');"></span>
					<div class="slide-front">
						<img class="icon" src="./images/inspiratorium_logo.svg"/>
						<span class="branding-bar">Inspiratorium</span>
					</div>
					<div  class="slide-back text-small d-flex flex-justify-center flex-align-center p-3" onclick="tileClick('http://ecraft.zsi.at/', undefined, event);">
						Let yourself inspire and discover amazing instructables via the association driven Inspiratorium
					</div>
                </div>
			</div>
			<!-- PLAN GROUP -->
			<div class="tiles-grid tiles-group size-2 fg-white" data-group-title="Plan">
				<div data-role="tile" class="bg-plan fg-white" data-effect="hover-slide-up">
				<!--helpClick('#eCraftSearchDialog', event);-->
					<span class="mif-question badge-top m-0 bg-transparent" onclick="infoClick('./about/ecraft-idea-help.html');"></span>
					<div class="slide-front">
						<img class="icon" src="./images/google-drive-logo-flat.png"/>
						<span class="branding-bar">eCraft Plan</span>
					</div>
					<div class="slide-back text-small d-flex flex-justify-center flex-align-center p-3" onclick="tileClick('./uef/ideation/index.html', 'eCraft Idea', event);">
						Use this to note down your ideas
					</div>
                </div>
				<div data-role="tile" class="bg-plan fg-white" data-effect="hover-slide-up">
				<!--helpClick('#eCraftSearchDialog', event);-->
					<span class="mif-question badge-top m-0 bg-transparent" onclick="infoClick('./about/trello-help.html');"></span>
					<div class="slide-front">
						<img class="icon" src="./images/trello-logo.png"/>
						<span class="branding-bar">Trello</span>
					</div>
					<div class="slide-back text-small d-flex flex-justify-center flex-align-center p-3" onclick="tileClick('https://trello.com/', undefined, event);">
						Trello helps you plan and work together
					</div>
                </div>
			</div>
		</div>
	</div>
	
	<!--Login Box and Hidden Data-->
	<form  id="loginForm" class="login-form p-3 mx-auto border db-default win-shadow" style="z-index:2;" data-overlay="true">
		
        <!--<form>-->
			<h1 class="text-light">Login to eCraft2Learn</h1>
			<hr class="thin"/>
			<div class="form-group">
				<label for="user_login">Username:</label>
				<input type="text" name="username" id="username" data-role="input" placeholder="Enter your name, nickname, or user name.">
			</div>
			<div class="form-group">
				<label for="user_password">Pilot Site:</label>
				<select class="fg-black" name="pilotsite" id="pilotsite">
					<option value='10'>Not at a pilot site</option>
					<option value='11'>Pataluoto School</option>
					<option value='12'>Lyseo High School</option>
					<option value='13'>Athens informal pilot site</option>
					<option value='14'>Athens formal pilot site</option>
				</select>
			</div>
            <div class="form-group">
                <button type="button" class="button primary" onclick="HandleUserLogin();">Login</button>
				<!--<button type="button" class="button link">Cancel</button>-->
				<script>
					function HandleUserLogin(){
						selectUser($("#username").val(), $("#pilotsite").val(), HandleLoginCallback);
					}
					function HandleLoginCallback(phpResponse){
						handleSelectUserResponse(phpResponse);
						if(window.sessionStorage.getItem("errorStatus")=="fail"){
							//TODO: I am assuming that the new user IS a group user. Later we should ask the user and act accordingly
							addUser($("#username").val(), $("#pilotsite").val(), 1);
							location.reload();
						}
						else{
							location.reload();
						}
					}
					$('#loginForm').keyup(function HandleKeyUp(event)
					{
						if(event.which == 13)
							HandleUserLogin();
					});
					$('#pilotsite').keydown(function HandleKeyUp(event)
					{
						event.preventDefault();
						if(event.which == 13)
							HandleUserLogin();
					});
				</script>
            </div>
			<div class="overlay" style="background: rgba(0, 0, 0, 0.5); z-index:-1;"></div>
        <!--</form>-->
	</form>
</body>
<script>
includeHTML();
</script>